$ ->
  Stripe.setPublishableKey "<%= Figaro.env.stripe_publishable_key %>"
  token = false
  $form = $("#user-registration-form")
  return if $form.length == 0

  stripeHandler = (status, response) =>
    if (response.error)
      $(".main-content").prepend($('<div class="error"></div>').text(response.error.message))
      $form.find("button").prop("disabled", false)
    else
      token = response.id
      $form.append($('<input type="hidden" name="stripe_token" />').val(token))
      $form.find('#card_number, #expiration').remove()
      $form.submit()

  $form.submit (e) =>
    return true if token
    $form.find("button").prop("disabled", true)
    dates = $("#expiration").val().split("/")
    Stripe.card.createToken({
      number: $("#card_number").val(),
      cvc: $("#cvc").val(),
      exp_month: dates[0],
      exp_year: dates[1]
    }, stripeHandler)
    false
